---
phase: 3.1-puzzle-downloader
plan: 02
subsystem: ui
tags: [react, fetch, cors, puzzle-download]

# Dependency graph
requires:
  - phase: 3.1-01
    provides: CORS proxy infrastructure
  - phase: 03
    provides: puzzle parsing (importPuzzle)
provides:
  - PuzzleDownloader UI component
  - Source registry with URL patterns
  - Direct-first fetch with proxy fallback
affects: [04, 05, 06]

# Tech tracking
tech-stack:
  added: []
  patterns: [direct-fetch-with-proxy-fallback, source-registry-pattern]

key-files:
  created:
    - src/services/puzzleSources/types.ts
    - src/services/puzzleSources/sources.ts
    - src/services/puzzleSources/fetchPuzzle.ts
    - src/components/PuzzleDownloader.tsx
    - src/components/PuzzleDownloader.css
    - .env.example
  modified:
    - src/App.tsx
    - src/App.css
    - src/lib/puzzleImport.ts
    - proxy/src/index.ts

key-decisions:
  - "Direct-first fetch with proxy fallback (try direct URL, fall back to CORS proxy if blocked)"
  - "herbach.dnsalias.com as reliable Universal crossword source (andrewsmcmeel.com 404s)"
  - "Source registry pattern with getDirectUrl function for URL construction"

patterns-established:
  - "Direct-fetch-first pattern: Try direct URL, catch CORS errors, fall back to proxy"

issues-created: []

# Metrics
duration: 18 min
completed: 2026-01-11
---

# Phase 3.1 Plan 02: Source Service and Downloader UI Summary

**PuzzleDownloader component with source picker, date picker, and direct-first fetch strategy using herbach.dnsalias.com Universal crossword archive**

## Performance

- **Duration:** 18 min
- **Started:** 2026-01-11T16:49:31Z
- **Completed:** 2026-01-11T17:08:19Z
- **Tasks:** 5 (4 auto + 1 human-verify checkpoint)
- **Files modified:** 10

## Accomplishments

- Created source registry with PuzzleSource type and Universal crossword configuration
- Implemented fetchPuzzle service with direct-first, proxy-fallback strategy
- Built PuzzleDownloader UI component with source dropdown, date picker, and download button
- Integrated PuzzleDownloader into App header alongside FilePicker
- Extended importPuzzle to accept ArrayBuffer (for downloaded puzzles)
- Fixed Universal crossword URL pattern (herbach.dnsalias.com works, andrewsmcmeel.com 404s)

## Task Commits

Each task was committed atomically:

1. **Task 1: Create source types and registry** - `499560f` (feat)
2. **Task 2: Create puzzle fetch service** - `6138b76` (feat)
3. **Task 3: Create PuzzleDownloader component** - `68aebd0` (feat)
4. **Task 4: Integrate PuzzleDownloader into App** - `74b5deb` (feat)
5. **Fix: Correct proxy URL and add direct-first fetch** - `36cee1b` (fix)
6. **Fix: Use herbach.dnsalias.com for Universal URLs** - `025fbdd` (fix)

## Files Created/Modified

- `src/services/puzzleSources/types.ts` - PuzzleSource interface with getDirectUrl
- `src/services/puzzleSources/sources.ts` - Source registry with Universal crossword
- `src/services/puzzleSources/fetchPuzzle.ts` - Fetch service with direct-first strategy
- `src/components/PuzzleDownloader.tsx` - Downloader UI component
- `src/components/PuzzleDownloader.css` - Component styles (dark theme)
- `src/App.tsx` - Added PuzzleDownloader to header
- `src/App.css` - Added puzzle-import wrapper styles
- `src/lib/puzzleImport.ts` - Extended to accept ArrayBuffer
- `.env.example` - Proxy URL environment variable documentation
- `proxy/src/index.ts` - Updated URL pattern

## Decisions Made

- **Direct-first fetch pattern:** Try fetching directly from source URL first, fall back to CORS proxy only if needed. This reduces proxy load and latency when sources allow CORS.
- **herbach.dnsalias.com as Universal source:** The syndication.andrewsmcmeel.com URL pattern returns 404 for all dates. Martin Herbach's archive at herbach.dnsalias.com/uc/ is reliable and well-maintained.
- **Source registry with URL function:** Each source defines its own getDirectUrl function for flexible URL construction per-source.

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Wrong proxy URL subdomain**
- **Found during:** Checkpoint verification
- **Issue:** Proxy URL was `crossing-words-proxy.workers.dev` but deployed to `msfstef.workers.dev` subdomain
- **Fix:** Updated fetchPuzzle.ts and .env.example to use correct URL
- **Commit:** `36cee1b`

**2. [Rule 1 - Bug] Universal crossword URL pattern returns 404**
- **Found during:** Checkpoint verification
- **Issue:** syndication.andrewsmcmeel.com URL pattern doesn't work (404 for all dates)
- **Fix:** Changed to herbach.dnsalias.com/uc/ucYYMMDD.puz pattern (verified working)
- **Files modified:** sources.ts, proxy/src/index.ts
- **Commit:** `025fbdd`

**3. [Rule 2 - Missing Critical] importPuzzle only accepted File objects**
- **Found during:** Task 3 implementation
- **Issue:** Existing importPuzzle couldn't handle ArrayBuffer from fetch response
- **Fix:** Extended function signature to accept ArrayBuffer with filename hint
- **Files modified:** src/lib/puzzleImport.ts
- **Commit:** `68aebd0` (part of Task 3)

---

**Total deviations:** 3 auto-fixed (2 bugs, 1 missing critical)
**Impact on plan:** All fixes necessary for functionality. Direct-first pattern is architectural improvement.

## Issues Encountered

- Universal crossword official URL (andrewsmcmeel.com) returns 404 - switched to community-maintained herbach archive
- Proxy was deployed to user-specific subdomain (msfstef.workers.dev) not generic workers.dev

## Next Phase Readiness

- Phase 3.1 complete - puzzle downloading works end-to-end
- Ready for Phase 4 (CRDT State) - puzzle loading foundation solid
- Note: Additional sources can be added to registry following same pattern

---
*Phase: 3.1-puzzle-downloader*
*Completed: 2026-01-11*
