# Phase 3.1: Puzzle Downloader - Research

**Researched:** 2026-01-11
**Domain:** Crossword puzzle downloading from online sources
**Confidence:** MEDIUM (CORS proxy approach validated, source stability varies)

<research_summary>
## Summary

Researched the crossword puzzle download ecosystem for building an automatic downloader with source/date picker. The fundamental challenge is CORS: most puzzle sources don't serve appropriate headers for browser-based fetching, requiring a proxy solution.

Key finding: **Don't hand-roll source URL discovery or puzzle fetching logic**. The xword-dl project has already solved this for 40+ outlets with active maintenance (latest release Oct 2025). However, xword-dl is Python-based and can't run in-browser. Two viable approaches exist:

1. **Cloudflare Worker proxy** - Serverless proxy that fetches puzzles server-side and adds CORS headers. Minimal infrastructure, free tier covers ~100K requests/day.
2. **Direct links to free sources** - Some aggregators (Crossword Fiend, Cruciverb) provide direct .puz links that may work with CORS proxy.

**Primary recommendation:** Implement a Cloudflare Worker proxy that fetches from known source URLs by date. Start with 3-5 free sources (LA Times, Universal, Washington Post Sunday, USA Today). Reference xword-dl's URL patterns but implement fetching in TypeScript for the Worker.
</research_summary>

<standard_stack>
## Standard Stack

### Core
| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| Cloudflare Workers | - | Serverless proxy | Free tier, global edge, CORS control |
| date-fns | 3.x | Date manipulation | Date picker, source URL formatting |
| xd-crossword-tools | existing | .puz/.jpz parsing | Already in project from Phase 3 |

### Supporting
| Library | Version | Purpose | When to Use |
|---------|---------|---------|-------------|
| itty-router | 5.x | Worker routing | If proxy needs multiple endpoints |
| zod | 3.x | Response validation | Validate source responses |

### Alternatives Considered
| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| CF Worker | AWS Lambda | Lambda requires more setup, CF simpler for CORS |
| CF Worker | Self-hosted proxy | Maintenance burden, availability concerns |
| Browser-only | No proxy | Won't work - CORS blocks most sources |

**Installation (client-side):**
```bash
npm install date-fns
# xd-crossword-tools already installed
```

**Worker setup:**
```bash
npm create cloudflare@latest -- crossing-words-proxy
```
</standard_stack>

<architecture_patterns>
## Architecture Patterns

### Recommended Project Structure
```
src/
├── components/
│   └── PuzzleDownloader/
│       ├── PuzzleDownloader.tsx    # Main component
│       ├── SourcePicker.tsx        # Dropdown for sources
│       ├── DatePicker.tsx          # Calendar/date input
│       └── DownloadButton.tsx      # Fetch and load
├── services/
│   └── puzzleSources/
│       ├── types.ts                # Source definitions
│       ├── sources.ts              # Source registry
│       └── fetchPuzzle.ts          # Proxy fetch wrapper
└── proxy/                          # Separate deployable
    └── worker.ts                   # Cloudflare Worker
```

### Pattern 1: Source Registry Pattern
**What:** Define sources as configuration, not code
**When to use:** Multiple sources with different URL patterns
**Example:**
```typescript
// Source: Project pattern
interface PuzzleSource {
  id: string;
  name: string;
  shortcode: string;
  urlPattern: (date: Date) => string;
  requiresAuth: boolean;
  format: 'puz' | 'jpz' | 'ipuz';
}

const sources: PuzzleSource[] = [
  {
    id: 'lat',
    name: 'LA Times',
    shortcode: 'lat',
    urlPattern: (date) => {
      // AmuseLabs pattern - needs proxy to fetch puzzle ID first
      const dateStr = format(date, 'yyyyMMdd');
      return `https://cdn3.amuselabs.com/lat/...`;
    },
    requiresAuth: false,
    format: 'puz',
  },
  // More sources...
];
```

### Pattern 2: Proxy Fetch Pattern
**What:** All external fetches go through CORS proxy
**When to use:** Any puzzle source that doesn't serve CORS headers
**Example:**
```typescript
// Source: Standard pattern
const PROXY_URL = 'https://crossing-words-proxy.workers.dev';

async function fetchPuzzle(sourceId: string, date: Date): Promise<ArrayBuffer> {
  const response = await fetch(`${PROXY_URL}/puzzle`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ source: sourceId, date: date.toISOString() }),
  });

  if (!response.ok) {
    throw new Error(`Failed to fetch: ${response.statusText}`);
  }

  return response.arrayBuffer();
}
```

### Pattern 3: Cloudflare Worker CORS Proxy
**What:** Serverless function that fetches upstream and adds CORS headers
**When to use:** Standard pattern for browser apps hitting non-CORS APIs
**Example:**
```typescript
// Source: Cloudflare docs + xword-dl patterns
export default {
  async fetch(request: Request): Promise<Response> {
    // Handle CORS preflight
    if (request.method === 'OPTIONS') {
      return new Response(null, {
        headers: {
          'Access-Control-Allow-Origin': '*',
          'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
          'Access-Control-Allow-Headers': 'Content-Type',
        },
      });
    }

    const { source, date } = await request.json();
    const url = getSourceUrl(source, new Date(date));

    const upstream = await fetch(url, {
      headers: {
        'User-Agent': 'CrossingWords/1.0',
      },
    });

    // Pass through the puzzle file
    const body = await upstream.arrayBuffer();

    return new Response(body, {
      headers: {
        'Access-Control-Allow-Origin': '*',
        'Content-Type': 'application/octet-stream',
      },
    });
  },
};
```

### Anti-Patterns to Avoid
- **Direct browser fetch to puzzle sources:** CORS will block most sources
- **Hardcoding dates in URL strings:** Use date-fns for reliable formatting
- **Fetching entire puzzle archives:** Only fetch the specific date requested
- **Storing user credentials in proxy:** Never handle NYT/WSJ auth server-side
</architecture_patterns>

<dont_hand_roll>
## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| URL patterns per source | Custom URL builders | Reference xword-dl patterns | They maintain 40+ sources actively |
| CORS proxying | nginx/Express server | Cloudflare Worker | Free, global, no maintenance |
| Date input | Custom calendar | Browser native or date-fns picker | Complex edge cases (timezones, DST) |
| Puzzle parsing | Binary parser | xd-crossword-tools (already in project) | .puz format is complex |
| Source discovery | Scrape for new sources | Use known free sources | Legal/ToS risk |

**Key insight:** The hardest part of puzzle downloading is discovering and maintaining source URL patterns. xword-dl has 7+ years of community effort on this. While we can't use it directly (Python), we can reference their patterns for the 5-10 free sources we support.
</dont_hand_roll>

<common_pitfalls>
## Common Pitfalls

### Pitfall 1: NYT and Subscription Sources
**What goes wrong:** Attempting to download NYT puzzles without subscription
**Why it happens:** NYT removed .puz downloads in Aug 2021, requires active subscription
**How to avoid:** Clearly label subscription sources, don't attempt to bypass auth
**Warning signs:** 403/401 responses, "subscription required" errors

### Pitfall 2: AmuseLabs Dynamic URLs
**What goes wrong:** Hardcoded URLs fail because puzzle IDs change
**Why it happens:** AmuseLabs (LA Times, Atlantic, etc.) uses dynamic puzzle IDs
**How to avoid:** Two-step fetch: get puzzle ID from date picker endpoint, then fetch puzzle
**Warning signs:** 404s on known good sources, "puzzle not found"

### Pitfall 3: CORS Whack-a-mole
**What goes wrong:** Sources randomly start/stop working
**Why it happens:** Sources change their CORS policies or URL patterns
**How to avoid:** Proxy all fetches (consistent), graceful error handling, user-visible status
**Warning signs:** Works in dev (proxy), fails in prod (no proxy)

### Pitfall 4: Date/Timezone Issues
**What goes wrong:** Wrong puzzle fetched, "no puzzle for this date" errors
**Why it happens:** Puzzle dates are in source's timezone (usually US Eastern)
**How to avoid:** Convert to source timezone before constructing URL, don't use user's local time
**Warning signs:** Puzzles "off by one day", works for some users not others

### Pitfall 5: Rate Limiting
**What goes wrong:** Proxy gets blocked by upstream sources
**Why it happens:** Too many requests from single IP (Cloudflare edge)
**How to avoid:** Cache puzzle files in Worker KV, rate limit client requests
**Warning signs:** 429 responses, temporary blocks
</common_pitfalls>

<code_examples>
## Code Examples

Verified patterns from official sources:

### Cloudflare Worker CORS Proxy
```typescript
// Source: Cloudflare Workers docs
const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
  'Access-Control-Allow-Headers': 'Content-Type',
  'Access-Control-Max-Age': '86400',
};

function handleOptions(request: Request): Response {
  return new Response(null, { headers: corsHeaders });
}

async function handleRequest(request: Request): Promise<Response> {
  if (request.method === 'OPTIONS') {
    return handleOptions(request);
  }

  // ... fetch puzzle from upstream

  return new Response(puzzleData, {
    headers: {
      ...corsHeaders,
      'Content-Type': 'application/octet-stream',
    },
  });
}
```

### Date Formatting for Source URLs
```typescript
// Source: date-fns docs
import { format, subDays } from 'date-fns';
import { toZonedTime } from 'date-fns-tz';

function getEasternDate(date: Date): Date {
  return toZonedTime(date, 'America/New_York');
}

// LA Times pattern (from xword-dl observation)
function getLATimesUrl(date: Date): string {
  const eastern = getEasternDate(date);
  const dateStr = format(eastern, 'yyMMdd');
  return `https://cdn3.amuselabs.com/lat/crossword?id=tca${dateStr}`;
}

// Universal pattern
function getUniversalUrl(date: Date): string {
  const eastern = getEasternDate(date);
  const dateStr = format(eastern, 'yyMMdd');
  return `https://cdn4.amuselabs.com/ucs/crossword?id=ucs-${dateStr}`;
}
```

### Source Picker Component
```tsx
// Source: Project pattern
interface SourcePickerProps {
  sources: PuzzleSource[];
  value: string;
  onChange: (sourceId: string) => void;
}

function SourcePicker({ sources, value, onChange }: SourcePickerProps) {
  const freeSources = sources.filter(s => !s.requiresAuth);

  return (
    <select
      value={value}
      onChange={(e) => onChange(e.target.value)}
      className="source-picker"
    >
      {freeSources.map(source => (
        <option key={source.id} value={source.id}>
          {source.name}
        </option>
      ))}
    </select>
  );
}
```
</code_examples>

<sota_updates>
## State of the Art (2025-2026)

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| NYT .puz download | Subscription-only web/app | Aug 2021 | Can't download NYT without account |
| Static puzzle URLs | AmuseLabs dynamic IDs | 2023+ | Need two-step fetch for many sources |
| Browser-only fetch | CORS proxy required | Always | Most sources don't serve CORS headers |
| Python xword-dl | xword-dl still active | Ongoing | Reference for URL patterns, can't use directly |

**New tools/patterns to consider:**
- **Cloudflare Workers KV:** Cache puzzle files to reduce upstream requests
- **Wrangler:** Modern Cloudflare Workers development tool
- **xword-dl 2025.x:** Active development, good source of URL pattern updates

**Deprecated/outdated:**
- **NYT Across Lite downloads:** Discontinued Aug 2021
- **Direct browser fetch:** Most sources now require proxy
- **Cruciverb direct .puz links:** Requires account, may have rate limits
</sota_updates>

<open_questions>
## Open Questions

Things that couldn't be fully resolved:

1. **AmuseLabs exact URL patterns**
   - What we know: Uses puzzle IDs that incorporate dates
   - What's unclear: Exact ID format varies by outlet (tca vs ucs vs etc.)
   - Recommendation: Test each source during implementation, reference xword-dl source code

2. **Rate limiting thresholds**
   - What we know: Sources may rate limit, Cloudflare Workers have daily limits
   - What's unclear: Specific thresholds per source
   - Recommendation: Implement caching early, monitor for 429s

3. **Source URL stability**
   - What we know: xword-dl needs frequent updates for broken sources
   - What's unclear: How often our supported sources will break
   - Recommendation: Start with most stable (Universal, WaPo), monitor xword-dl releases
</open_questions>

<sources>
## Sources

### Primary (HIGH confidence)
- [xword-dl GitHub](https://github.com/thisisparker/xword-dl) - 40+ outlet support, active maintenance
- [Cloudflare Workers CORS Proxy docs](https://developers.cloudflare.com/workers/examples/cors-header-proxy/) - Official implementation pattern
- [Crossword Fiend download page](https://crosswordfiend.com/download/) - Daily index of free puzzles

### Secondary (MEDIUM confidence)
- [CommuniCrossings source list](https://communicrossings.com/crosswords-sources-web-sites) - Comprehensive source catalog
- [xword-dl releases](https://github.com/thisisparker/xword-dl/releases) - URL pattern changes tracked in changelog
- [Slashdot: NYT .puz discontinued](https://games.slashdot.org/story/21/08/04/2225205/nyt-crossword-puzzle-no-longer-works-in-third-party-apps) - Aug 2021 NYT change

### Tertiary (LOW confidence - needs validation)
- AmuseLabs URL patterns - Inferred from xword-dl, needs testing
- Source rate limits - Not documented, needs experimentation
</sources>

<metadata>
## Metadata

**Research scope:**
- Core technology: CORS proxy (Cloudflare Workers)
- Ecosystem: xword-dl patterns, free puzzle sources
- Patterns: Proxy fetch, source registry, date handling
- Pitfalls: CORS, subscriptions, dynamic URLs, timezones

**Confidence breakdown:**
- Standard stack: HIGH - Cloudflare Workers well-documented
- Architecture: HIGH - Standard proxy pattern, proven
- Pitfalls: MEDIUM - Based on xword-dl issues, needs validation
- Code examples: HIGH - From official docs

**Research date:** 2026-01-11
**Valid until:** 2026-02-11 (30 days - source URLs may change)
</metadata>

---

## Recommended Initial Sources (Free, No Auth)

Based on research, prioritize these sources for initial implementation:

| Source | Stability | Format | Notes |
|--------|-----------|--------|-------|
| LA Times | HIGH | .puz via AmuseLabs | Active daily, xword-dl maintained |
| Universal | HIGH | .puz | Andrews McMeel, stable archive |
| USA Today | MEDIUM | Web-based | May need scraping |
| Washington Post Sunday | HIGH | .puz | Weekly themed, stable |
| New Yorker | MEDIUM | Web-based | Mon-Fri via Puzzmo |

**Not recommended initially:**
- NYT (subscription required)
- WSJ (subscription for some)
- Newsday (requires account)

---

*Phase: 3.1-puzzle-downloader*
*Research completed: 2026-01-11*
*Ready for planning: yes*
