---
phase: 04-crdt-state
plan: 01
type: execute
---

<objective>
Set up Yjs CRDT infrastructure with IndexedDB persistence for offline-capable puzzle state.

Purpose: Establish the foundation for conflict-free multiplayer sync that Phase 5 and 6 build upon.
Output: Working CRDT module with Y.Doc, Y.Map for entries, and IndexedDB persistence per puzzle.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-crdt-state/04-RESEARCH.md
@.planning/phases/04-crdt-state/04-CONTEXT.md
@src/types/puzzle.ts
@src/hooks/usePuzzleState.ts

**Tech stack available:** React 19, TypeScript, Vite
**Established patterns:**
- Cell coordinate format: "row,col" string key for Maps
- Map<string, string> for userEntries lookup

**Key guidance from research:**
- Use flat Y.Map with "row,col" keys (matches existing pattern)
- ONE Y.Doc per puzzle, ONE Y.Map for all entries
- IndexeddbPersistence with puzzle ID in storage key
- Wait for 'synced' event before exposing state
- Don't hand-roll: conflict resolution, sync protocol, persistence
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Yjs and create puzzle document module</name>
  <files>package.json, src/crdt/puzzleDoc.ts</files>
  <action>
1. Install dependencies: `npm install yjs y-indexeddb`

2. Create src/crdt/puzzleDoc.ts with:
   - `createPuzzleDoc(puzzleId: string)` factory function that returns Y.Doc
   - Export type for entries map: `Y.Map<string>` (values are single letters)
   - `getEntriesMap(doc: Y.Doc)` helper that returns `doc.getMap<string>('entries')`
   - Document the "row,col" key format convention in JSDoc

Keep it simple - just the Y.Doc factory and Y.Map accessor. Persistence is Task 2.

Do NOT create singleton/global doc - each puzzle gets its own doc instance.
  </action>
  <verify>
- `npm ls yjs y-indexeddb` shows both installed
- `npm run build` succeeds with no TypeScript errors
- src/crdt/puzzleDoc.ts exports createPuzzleDoc and getEntriesMap
  </verify>
  <done>
- yjs and y-indexeddb in package.json dependencies
- puzzleDoc.ts creates Y.Doc with typed Y.Map<string> for entries
- Build passes
  </done>
</task>

<task type="auto">
  <name>Task 2: Add IndexedDB persistence layer</name>
  <files>src/crdt/puzzleStore.ts</files>
  <action>
Create src/crdt/puzzleStore.ts that wraps Y.Doc with IndexedDB persistence:

1. `PuzzleStore` class or factory with:
   - Constructor takes puzzleId, creates Y.Doc via puzzleDoc.ts
   - Creates IndexeddbPersistence with key `puzzle-${puzzleId}`
   - Exposes `ready: Promise<void>` that resolves on 'synced' event
   - Exposes `entries: Y.Map<string>` for direct access
   - Exposes `doc: Y.Doc` for future provider attachment (Phase 5)
   - `destroy()` method that calls `persistence.destroy()` for cleanup

2. Handle the 'synced' event properly:
   ```typescript
   this.ready = new Promise(resolve => {
     persistence.on('synced', () => resolve())
   })
   ```

3. Export a `createPuzzleStore(puzzleId: string)` function

The puzzleId will be derived from puzzle content (title hash or similar) - for now accept any string.

Do NOT handle React integration here - that's Plan 2.
  </action>
  <verify>
- `npm run build` succeeds
- src/crdt/puzzleStore.ts exports createPuzzleStore
- PuzzleStore has: ready promise, entries map, doc, destroy method
  </verify>
  <done>
- puzzleStore.ts provides complete CRDT + persistence wrapper
- Ready promise resolves after IndexedDB sync
- Destroy method available for cleanup
- Build passes with no errors
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm run lint` passes (or only pre-existing warnings)
- [ ] src/crdt/ directory contains puzzleDoc.ts and puzzleStore.ts
- [ ] Both modules export their documented functions/types
</verification>

<success_criteria>

- yjs and y-indexeddb installed
- CRDT module created with Y.Doc factory and Y.Map accessor
- Persistence layer wraps IndexedDB with ready state
- All verification checks pass
- Ready for React integration (Plan 2)
</success_criteria>

<output>
After completion, create `.planning/phases/04-crdt-state/04-01-SUMMARY.md` following the summary template.
</output>
