---
phase: 08-polish-pwa
plan: 01
type: execute
domain: frontend-design
---

<objective>
Implement CSS custom properties theme system with dark/light mode toggle and system preference detection.

Purpose: Establish the foundational theming infrastructure that all subsequent UI work will build upon.
Output: Theme CSS variables, useTheme hook, theme toggle component, FART prevention.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-polish-pwa/08-CONTEXT.md
@.planning/phases/08-polish-pwa/08-RESEARCH.md
@src/App.css
@src/index.css

**Tech stack available:** React 19, Vite, vite-plugin-pwa, sonner
**Established patterns:** CSS custom properties, useSyncExternalStore for subscriptions
**Constraining decisions:**
- Phase 01: Dark theme (#1a1a2e) as default

**From RESEARCH.md:**
- Use CSS custom properties with data-attribute toggle
- Add blocking script in <head> to prevent theme flash
- Three-option theme: light, dark, system
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create theme CSS with custom properties</name>
  <files>src/styles/theme.css</files>
  <action>
Create src/styles/theme.css with CSS custom properties for both themes.

Define :root with light theme as structural default (but dark will be applied by blocking script for users preferring dark).

Variables to define:
- --color-bg: main background
- --color-bg-secondary: cards, panels
- --color-bg-tertiary: input backgrounds
- --color-text: primary text
- --color-text-muted: secondary text
- --color-border: dividers, borders
- --color-accent: interactive elements, links
- --color-accent-hover: accent hover state
- --color-cell-bg: crossword cell background
- --color-cell-selected: selected cell highlight
- --color-cell-word: current word cells
- --color-cell-blocked: blocked cells
- --color-verified: green for verified cells
- --color-error: red for error cells
- --color-keyboard-bg: keyboard background
- --color-keyboard-key: key background
- --color-keyboard-key-active: key press state

Dark theme via [data-theme="dark"] selector using the existing #1a1a2e palette.

Import this in main.tsx before App.
  </action>
  <verify>File exists and has both :root and [data-theme="dark"] selectors</verify>
  <done>Theme CSS file created with comprehensive color palette for both themes</done>
</task>

<task type="auto">
  <name>Task 2: Create useTheme hook with persistence</name>
  <files>src/hooks/useTheme.ts</files>
  <action>
Create useTheme hook that:
1. Reads initial theme from localStorage ('theme' key), defaulting to 'system'
2. Returns { theme, resolvedTheme, setTheme }
3. theme is 'light' | 'dark' | 'system'
4. resolvedTheme is the actual 'light' | 'dark' after resolving system preference
5. setTheme persists to localStorage and updates document.documentElement.dataset.theme
6. Listens for prefers-color-scheme changes when in 'system' mode
7. Uses useSyncExternalStore pattern for system preference to match project conventions

The hook should NOT set theme on initial render - that's handled by the blocking script.
Only set theme on subsequent changes.
  </action>
  <verify>Hook compiles without TypeScript errors</verify>
  <done>useTheme hook with localStorage persistence and system preference detection</done>
</task>

<task type="auto">
  <name>Task 3: Add blocking script for FART prevention and integrate theme</name>
  <files>index.html, src/main.tsx</files>
  <action>
In index.html, add blocking script in &lt;head&gt; BEFORE any other scripts:

```html
<script>
  (function() {
    var theme = localStorage.getItem('theme');
    var resolved = theme;
    if (!theme || theme === 'system') {
      resolved = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    }
    document.documentElement.dataset.theme = resolved;
  })();
</script>
```

In src/main.tsx, import theme.css before App:
```typescript
import './styles/theme.css';
```

This ensures correct theme is applied before first paint.
  </action>
  <verify>npm run build succeeds, no hydration errors in dev mode</verify>
  <done>Theme applied before first paint, no flash of wrong theme</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm run dev` - page loads with dark theme (if system prefers dark)
- [ ] Browser DevTools shows CSS variables on :root
- [ ] No flash of wrong theme on page load
</verification>

<success_criteria>

- All tasks completed
- Theme CSS with custom properties for light/dark
- useTheme hook with localStorage persistence
- Blocking script prevents FART
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-polish-pwa/08-01-SUMMARY.md`
</output>
