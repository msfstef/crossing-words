---
phase: 3.1-puzzle-downloader
plan: 02
type: execute
---

<objective>
Create source registry, fetch service, and PuzzleDownloader UI component.

Purpose: Provide a user-facing interface for selecting a puzzle source and date, then fetching and loading the puzzle via the CORS proxy.

Output: Working PuzzleDownloader component that fetches puzzles from configured sources by date.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/3.1-automatic-downloader-from-remote-sources-with-picker-for-source-and-day/3.1-RESEARCH.md
@.planning/phases/3.1-automatic-downloader-from-remote-sources-with-picker-for-source-and-day/3.1-01-SUMMARY.md

**Prior plan output:**
- proxy/ directory with Cloudflare Worker
- Proxy URL (from 3.1-01-SUMMARY.md)

**Existing patterns to follow:**
- FilePicker uses hidden file input pattern
- Error handling with auto-dismiss toast (5s)
- Components in src/components/ with matching .css files
- Hooks in src/hooks/

**From RESEARCH.md - Don't hand-roll:**
- Date input: Use browser native date input
- Puzzle parsing: Use existing importPuzzle (xd-crossword-tools)

**From RESEARCH.md - Pitfalls:**
- Timezone issues: Puzzle dates are US Eastern, convert before URL construction
- AmuseLabs dynamic URLs: Start with Universal (static pattern) for reliability

**Key files:**
@src/App.tsx
@src/components/FilePicker.tsx
@src/lib/puzzleImport.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create source types and registry</name>
  <files>src/services/puzzleSources/types.ts, src/services/puzzleSources/sources.ts</files>
  <action>
Create src/services/puzzleSources/ directory.

Create types.ts:
```typescript
export interface PuzzleSource {
  id: string;
  name: string;
  description: string;
  format: 'puz' | 'jpz' | 'ipuz';
  requiresAuth: boolean;
  availableDays: 'daily' | 'weekdays' | 'sunday-only';
}
```

Create sources.ts with initial free sources:
```typescript
export const PUZZLE_SOURCES: PuzzleSource[] = [
  {
    id: 'universal',
    name: 'Universal Crossword',
    description: 'Daily puzzle from Andrews McMeel',
    format: 'puz',
    requiresAuth: false,
    availableDays: 'daily',
  },
  // Add LA Times when proxy supports it
];

export function getSource(id: string): PuzzleSource | undefined {
  return PUZZLE_SOURCES.find(s => s.id === id);
}
```

Keep it simple - just Universal for now since the proxy only supports that source. Additional sources can be added when proxy expands.
  </action>
  <verify>TypeScript compiles: `npm run build` (no type errors in new files)</verify>
  <done>Source types and registry created with Universal source defined</done>
</task>

<task type="auto">
  <name>Task 2: Create puzzle fetch service</name>
  <files>src/services/puzzleSources/fetchPuzzle.ts</files>
  <action>
Create fetchPuzzle.ts that fetches puzzles via the proxy:

```typescript
// Read proxy URL from environment or fallback
const PROXY_URL = import.meta.env.VITE_PROXY_URL || 'https://crossing-words-proxy.workers.dev';

export async function fetchPuzzle(sourceId: string, date: Date): Promise<ArrayBuffer> {
  const response = await fetch(`${PROXY_URL}/puzzle`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      source: sourceId,
      date: date.toISOString(),
    }),
  });

  if (!response.ok) {
    if (response.status === 404) {
      throw new Error('Puzzle not found for this date');
    }
    if (response.status === 400) {
      throw new Error('Invalid source selected');
    }
    throw new Error(`Failed to fetch puzzle: ${response.statusText}`);
  }

  return response.arrayBuffer();
}
```

Add VITE_PROXY_URL to .env.example (create if doesn't exist):
```
VITE_PROXY_URL=https://crossing-words-proxy.workers.dev
```

This allows configuring the proxy URL during development/deployment.
  </action>
  <verify>TypeScript compiles without errors</verify>
  <done>fetchPuzzle service created, environment variable documented</done>
</task>

<task type="auto">
  <name>Task 3: Create PuzzleDownloader component</name>
  <files>src/components/PuzzleDownloader.tsx, src/components/PuzzleDownloader.css</files>
  <action>
Create PuzzleDownloader.tsx - a component similar to FilePicker but for downloading from sources:

```tsx
import { useState } from 'react';
import { PUZZLE_SOURCES } from '../services/puzzleSources/sources';
import { fetchPuzzle } from '../services/puzzleSources/fetchPuzzle';
import { importPuzzle } from '../lib/puzzleImport';
import type { Puzzle } from '../types/puzzle';
import './PuzzleDownloader.css';

interface PuzzleDownloaderProps {
  onPuzzleLoaded: (puzzle: Puzzle) => void;
  onError: (error: string) => void;
}

export function PuzzleDownloader({ onPuzzleLoaded, onError }: PuzzleDownloaderProps) {
  const [sourceId, setSourceId] = useState(PUZZLE_SOURCES[0]?.id || '');
  const [date, setDate] = useState(() => {
    // Default to today in YYYY-MM-DD format for date input
    return new Date().toISOString().split('T')[0];
  });
  const [loading, setLoading] = useState(false);

  const handleDownload = async () => {
    if (!sourceId || !date) return;

    setLoading(true);
    try {
      const source = PUZZLE_SOURCES.find(s => s.id === sourceId);
      if (!source) throw new Error('Invalid source');

      const puzzleDate = new Date(date + 'T12:00:00'); // Noon to avoid timezone edge cases
      const buffer = await fetchPuzzle(sourceId, puzzleDate);

      // Use existing importPuzzle with filename hint for format detection
      const puzzle = await importPuzzle(buffer, `puzzle.${source.format}`);
      onPuzzleLoaded(puzzle);
    } catch (err) {
      onError(err instanceof Error ? err.message : 'Failed to download puzzle');
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="puzzle-downloader">
      <select
        value={sourceId}
        onChange={(e) => setSourceId(e.target.value)}
        className="puzzle-downloader__source"
        disabled={loading}
      >
        {PUZZLE_SOURCES.map(source => (
          <option key={source.id} value={source.id}>
            {source.name}
          </option>
        ))}
      </select>

      <input
        type="date"
        value={date}
        onChange={(e) => setDate(e.target.value)}
        className="puzzle-downloader__date"
        disabled={loading}
        max={new Date().toISOString().split('T')[0]} // Can't fetch future puzzles
      />

      <button
        onClick={handleDownload}
        disabled={loading || !sourceId || !date}
        className="puzzle-downloader__button"
      >
        {loading ? 'Loading...' : 'Download'}
      </button>
    </div>
  );
}
```

Create PuzzleDownloader.css with styling matching FilePicker:
- Horizontal flex layout
- Dark theme colors (#1a1a2e background palette)
- Consistent button styling with FilePicker
- Loading state with reduced opacity
  </action>
  <verify>TypeScript compiles, component renders without errors</verify>
  <done>PuzzleDownloader component created with source picker, date picker, and download button</done>
</task>

<task type="auto">
  <name>Task 4: Integrate PuzzleDownloader into App</name>
  <files>src/App.tsx, src/App.css</files>
  <action>
Add PuzzleDownloader to App.tsx header, alongside existing FilePicker:

1. Import PuzzleDownloader
2. Add it to the header section after FilePicker
3. Pass the same onPuzzleLoaded and onError handlers
4. Consider adding a small label or separator between FilePicker and PuzzleDownloader

Update App.css if needed:
- Ensure header has proper flex layout for both components
- Consider adding "or" separator between file picker and downloader
- Maintain responsive layout for mobile

The two import methods (file and download) should be visually grouped but distinct.
  </action>
  <verify>npm run dev - App loads without errors, both FilePicker and PuzzleDownloader visible</verify>
  <done>PuzzleDownloader integrated into App header</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete puzzle downloader feature with source picker, date picker, and proxy integration</what-built>
  <how-to-verify>
1. Run: `npm run dev`
2. Visit: http://localhost:5173
3. Verify UI:
   - PuzzleDownloader visible in header (source dropdown, date picker, Download button)
   - FilePicker still present and functional
4. Test download (if proxy deployed):
   - Select "Universal Crossword" source
   - Select a recent date (e.g., yesterday)
   - Click "Download"
   - Puzzle should load and display in grid
5. Test error handling:
   - Select a date far in the future
   - Should show error toast
6. If proxy NOT deployed:
   - Download will fail with network error (expected)
   - Verify UI elements work correctly
   - Note: Full testing requires deployed proxy
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] Source registry exists with Universal source
- [ ] fetchPuzzle service handles proxy communication
- [ ] PuzzleDownloader component renders in App
- [ ] Date picker defaults to today, has max of today
- [ ] Loading state disables controls during fetch
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- PuzzleDownloader integrated and functional
- Error handling matches existing FilePicker pattern
- UI consistent with dark theme
</success_criteria>

<output>
After completion, create `.planning/phases/3.1-automatic-downloader-from-remote-sources-with-picker-for-source-and-day/3.1-02-SUMMARY.md`:

# Phase 3.1 Plan 02: Source Service and Downloader UI Summary

**[One-liner: what was accomplished]**

## Accomplishments

- [Key outcomes]

## Files Created/Modified

- `src/services/puzzleSources/types.ts` - Source type definitions
- `src/services/puzzleSources/sources.ts` - Source registry
- `src/services/puzzleSources/fetchPuzzle.ts` - Proxy fetch service
- `src/components/PuzzleDownloader.tsx` - Downloader component
- `src/components/PuzzleDownloader.css` - Component styles
- `src/App.tsx` - Integration
- `.env.example` - Environment variable documentation

## Decisions Made

[Key decisions and rationale]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Phase 3.1 complete, ready for Phase 4 (CRDT State)
</output>
