---
phase: 08-polish-pwa
plan: 05
type: execute
domain: frontend-design
---

<objective>
Add offline status indicator, theme toggle UI, and PWA polish (runtime caching, install prompt).

Purpose: Complete the PWA experience with offline awareness and user preferences.
Output: Online status indicator, theme toggle in settings, runtime caching config.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-polish-pwa/08-CONTEXT.md
@.planning/phases/08-polish-pwa/08-RESEARCH.md
@.planning/phases/08-polish-pwa/08-04-PLAN.md
@src/hooks/useTheme.ts
@vite.config.ts

**Tech stack available:** React 19, vite-plugin-pwa, Workbox
**Established patterns:** useSyncExternalStore for subscriptions

**From RESEARCH.md:**
- useOnlineStatus hook with navigator.onLine + event listeners
- Runtime caching for puzzle API requests
- Install prompt via beforeinstallprompt (browser-native, no custom UI needed)

**Key features:**
- Offline indicator in header
- Theme toggle (light/dark/system)
- Runtime caching for puzzle downloads
- PWA installability maintained
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useOnlineStatus hook</name>
  <files>src/hooks/useOnlineStatus.ts</files>
  <action>
Create hook using useSyncExternalStore pattern (matches project conventions):

```typescript
import { useSyncExternalStore } from 'react';

function subscribe(callback: () => void) {
  window.addEventListener('online', callback);
  window.addEventListener('offline', callback);
  return () => {
    window.removeEventListener('online', callback);
    window.removeEventListener('offline', callback);
  };
}

function getSnapshot() {
  return navigator.onLine;
}

function getServerSnapshot() {
  return true; // SSR assumes online
}

export function useOnlineStatus(): boolean {
  return useSyncExternalStore(subscribe, getSnapshot, getServerSnapshot);
}
```

Simple, no dependencies, follows established patterns.
  </action>
  <verify>Hook compiles without TypeScript errors</verify>
  <done>useOnlineStatus hook for offline detection</done>
</task>

<task type="auto">
  <name>Task 2: Add offline indicator to header</name>
  <files>src/components/Layout/SolveHeader.tsx, src/components/Layout/SolveHeader.css, src/components/Library/LibraryView.tsx</files>
  <action>
Add offline indicator to both views:

**SolveHeader.tsx changes:**
Add prop: `isOnline: boolean`
Show offline indicator when !isOnline:
- Small banner or badge near connection status
- Text: "Offline" with icon
- Subtle but noticeable (different from P2P connection indicator)
- Use var(--color-text-muted) for subtle styling

**SolveHeader.css:**
```css
.offline-indicator {
  display: flex;
  align-items: center;
  gap: 4px;
  color: var(--color-text-muted);
  font-size: 0.75rem;
}
.offline-indicator::before {
  content: '';
  width: 8px;
  height: 8px;
  background: var(--color-error);
  border-radius: 50%;
}
```

**LibraryView.tsx changes:**
Add offline indicator in library header as well (if offline, downloading won't work).
Consider showing a subtle toast or banner: "You're offline - puzzles may not be up to date"

Wire useOnlineStatus in App.tsx and pass isOnline to components.
  </action>
  <verify>npm run dev, simulate offline in DevTools - indicator appears</verify>
  <done>Offline indicator in header and library</done>
</task>

<task type="auto">
  <name>Task 3: Add theme toggle to settings menu</name>
  <files>src/components/SettingsMenu.tsx, src/components/SettingsMenu.css, src/App.tsx</files>
  <action>
Create settings menu with theme toggle:

**SettingsMenu.tsx:**
- Dropdown/modal triggered from header menu button
- Theme selection: Light / Dark / System (radio buttons or segmented control)
- Uses useTheme hook to get/set current theme
- Close on selection

**SettingsMenu.css:**
- Modal/dropdown styling with theme variables
- Segmented control or radio button styling
- Matches app design language

**App.tsx changes:**
1. Import and use useTheme hook at App level
2. Pass theme controls to SettingsMenu
3. Add SettingsMenu to header menu (alongside Toolbar dropdowns)

The menu could be:
- A separate dropdown from the â‹® button
- Or integrated into existing Toolbar component
- Recommend: Keep Toolbar for puzzle actions, add Settings for user preferences
  </action>
  <verify>Theme toggle works - changing to dark/light updates UI immediately</verify>
  <done>Theme toggle accessible via settings menu</done>
</task>

<task type="auto">
  <name>Task 4: Configure PWA runtime caching</name>
  <files>vite.config.ts</files>
  <action>
Extend vite-plugin-pwa configuration with runtime caching:

```typescript
VitePWA({
  registerType: 'autoUpdate',
  workbox: {
    globPatterns: ['**/*.{js,css,html,ico,png,svg,woff2}'],
    runtimeCaching: [
      {
        // Cache puzzle downloads from CORS proxy
        urlPattern: /^https:\/\/crossing-words-proxy\..*\.workers\.dev\/puzzle/i,
        handler: 'NetworkFirst',
        options: {
          cacheName: 'puzzle-api-cache',
          expiration: {
            maxEntries: 50,
            maxAgeSeconds: 60 * 60 * 24 * 7, // 7 days
          },
          networkTimeoutSeconds: 10,
        },
      },
      {
        // Cache external puzzle sources (with fallback to cache)
        urlPattern: /^https:\/\/(www\.)?.*\.(puz|ipuz|jpz|json)$/i,
        handler: 'CacheFirst',
        options: {
          cacheName: 'puzzle-files-cache',
          expiration: {
            maxEntries: 100,
            maxAgeSeconds: 60 * 60 * 24 * 30, // 30 days
          },
        },
      },
    ],
  },
  manifest: {
    // ... existing manifest
  },
})
```

This enables:
- Puzzle downloads cached for offline access
- Network-first for API (fresh data when online)
- Cache-first for puzzle files (they don't change)
  </action>
  <verify>npm run build, check generated sw.js includes caching config</verify>
  <done>PWA runtime caching configured for puzzle downloads</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Offline indicator, theme toggle, and PWA caching</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Open DevTools Network tab
    3. Toggle "Offline" mode
    4. Verify offline indicator appears in header
    5. Find settings/theme menu
    6. Toggle theme between Light, Dark, System
    7. Verify theme changes immediately, no flash on page reload
    8. Build for production: npm run build
    9. Serve production build: npm run preview
    10. Test PWA installability (browser install prompt)
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] Offline indicator shows when network offline
- [ ] Theme toggle works with persistence
- [ ] No theme flash on reload
- [ ] PWA installable
</verification>

<success_criteria>

- All tasks completed
- Offline awareness working
- Theme preferences persisted
- PWA caching configured
- Phase 8 complete
</success_criteria>

<output>
After completion, create `.planning/phases/08-polish-pwa/08-05-SUMMARY.md`

Note: This is the final plan for Phase 8. Mark phase as complete in ROADMAP.md and STATE.md.
</output>
