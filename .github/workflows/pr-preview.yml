name: PR Preview

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: pr-preview-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  deploy-preview:
    if: github.event.action != 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build for PR preview
        run: npm run build
        env:
          VITE_BASE_PATH: /crossing-words/pr-preview/pr-${{ github.event.pull_request.number }}/

      - name: Deploy PR preview
        # v4.0.0 - pinned for security
        uses: peaceiris/actions-gh-pages@4f9cc6602d3f66b9c108549d475ec49e8ef4d45e
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist
          destination_dir: pr-preview/pr-${{ github.event.pull_request.number }}
          keep_files: true

      - name: Find existing comment
        # v3.1.0 - pinned for security
        uses: peter-evans/find-comment@3eae4d37986fb5a8592848f6a574fdf654e61f9e
        id: find-comment
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: "github-actions[bot]"
          body-includes: "## ðŸš€ PR Preview"

      - name: Create or update comment
        # v4.0.0 - pinned for security
        uses: peter-evans/create-or-update-comment@71345be0265236311c031f5c7866368bd1eff043
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          edit-mode: replace
          body: |
            ## ðŸš€ PR Preview

            Your preview deployment is ready!

            **Preview URL:** https://${{ github.repository_owner }}.github.io/crossing-words/pr-preview/pr-${{ github.event.pull_request.number }}/

            _Last updated: ${{ github.event.pull_request.updated_at || github.event.pull_request.created_at }}_

            ---
            <sub>This comment is automatically updated with each push to this PR.</sub>

  cleanup-preview:
    if: github.event.action == 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          fetch-depth: 0

      - name: Delete PR preview directory
        run: |
          if [ -d "pr-preview/pr-${{ github.event.pull_request.number }}" ]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git rm -rf "pr-preview/pr-${{ github.event.pull_request.number }}"
            git commit -m "Clean up PR #${{ github.event.pull_request.number }} preview"
            git push origin gh-pages
          else
            echo "PR preview directory does not exist, skipping cleanup"
          fi

      - name: Find existing comment
        # v3.1.0 - pinned for security
        uses: peter-evans/find-comment@3eae4d37986fb5a8592848f6a574fdf654e61f9e
        id: find-comment
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: "github-actions[bot]"
          body-includes: "## ðŸš€ PR Preview"

      - name: Update comment to indicate cleanup
        if: steps.find-comment.outputs.comment-id != ''
        # v4.0.0 - pinned for security
        uses: peter-evans/create-or-update-comment@71345be0265236311c031f5c7866368bd1eff043
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          edit-mode: replace
          body: |
            ## ðŸš€ PR Preview

            ~~Your preview deployment is ready!~~

            **Preview has been cleaned up** as this PR was closed.

            ---
            <sub>Preview deployments are automatically removed when PRs are closed.</sub>
