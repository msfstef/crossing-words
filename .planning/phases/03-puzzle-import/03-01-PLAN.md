---
phase: 03-puzzle-import
plan: 01
type: execute
---

<objective>
Create parsers for .puz, .ipuz, and .jpz crossword file formats.

Purpose: Enable the app to load puzzles from common crossword file formats used by major puzzle sources.
Output: Parsing functions that convert external formats to our internal Puzzle type.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-puzzle-import/03-CONTEXT.md
@.planning/phases/03-puzzle-import/DISCOVERY.md
@.planning/phases/02-puzzle-core/02-03-SUMMARY.md
@src/types/puzzle.ts
@src/lib/samplePuzzle.ts

**Tech stack available:** React, TypeScript, Vite
**Established patterns:** Puzzle type with Cell/Clue/PuzzleState interfaces

**Constraining decisions:**
- Phase 02: Cell stores solution in letter field
- Phase 02: Clue includes row, col, length for position-based lookup

**From DISCOVERY.md:**
- Use xd-crossword-tools for .puz and .jpz (don't hand-roll binary/XML parsing)
- Parse .ipuz directly (JSON format)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install xd-crossword-tools and create format parsers</name>
  <files>package.json, src/lib/parsers/puzParser.ts, src/lib/parsers/ipuzParser.ts, src/lib/parsers/jpzParser.ts</files>
  <action>
Install xd-crossword-tools: `npm install xd-crossword-tools`

Create src/lib/parsers/ directory with three parser files:

**puzParser.ts:**
- Import puzToXD, xdToJSON from xd-crossword-tools
- Export `parsePuz(buffer: ArrayBuffer): Puzzle` that:
  1. Converts ArrayBuffer to Uint8Array
  2. Calls puzToXD to get xd string
  3. Calls xdToJSON to get intermediate JSON
  4. Converts to our Puzzle type (map grid, extract clues)

**ipuzParser.ts:**
- Export `parseIpuz(jsonString: string): Puzzle` that:
  1. Parses JSON with JSON.parse
  2. Extracts dimensions, puzzle grid, solution, clues
  3. Converts to our Puzzle type
  4. ipuz uses { dimensions: {width, height}, puzzle: [[]], solution: [[]], clues: {Across:[], Down:[]} }

**jpzParser.ts:**
- Import jpzToXD, xdToJSON from xd-crossword-tools
- Export `parseJpz(buffer: ArrayBuffer): Puzzle` that:
  1. Converts buffer to string (UTF-8)
  2. Calls jpzToXD to get xd string
  3. Calls xdToJSON to get intermediate JSON
  4. Converts to our Puzzle type

Each parser should:
- Throw descriptive errors for invalid/malformed files
- Handle missing optional fields (author, title) gracefully
- Generate clue numbers from grid structure if not provided
  </action>
  <verify>
Import each parser in a test file or console and verify no TypeScript errors:
`npx tsc --noEmit`
  </verify>
  <done>Three parser files exist, TypeScript compiles, functions exported correctly</done>
</task>

<task type="auto">
  <name>Task 2: Create unified import function with format detection</name>
  <files>src/lib/puzzleImport.ts</files>
  <action>
Create src/lib/puzzleImport.ts that exports:

**detectFormat(filename: string, buffer: ArrayBuffer): 'puz' | 'ipuz' | 'jpz' | null**
- First check file extension (.puz, .ipuz, .jpz)
- For .puz: verify magic bytes if needed (ACROSS&DOWN at offset 2)
- Return null if format unrecognized

**importPuzzle(file: File): Promise<Puzzle>**
- Read file as ArrayBuffer using FileReader or file.arrayBuffer()
- Call detectFormat to determine type
- For ipuz: also read as text since it's JSON
- Dispatch to appropriate parser (parsePuz, parseIpuz, parseJpz)
- Throw clear error if format not recognized
- Wrap parser errors with user-friendly messages

**Error handling:**
- "Unsupported file format. Please use .puz, .ipuz, or .jpz files."
- "Invalid puzzle file: [specific error from parser]"
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>importPuzzle function exists that accepts File and returns Promise<Puzzle></done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npx tsc --noEmit` passes
- [ ] All parser files exist in src/lib/parsers/
- [ ] puzzleImport.ts exports importPuzzle function
</verification>

<success_criteria>

- xd-crossword-tools installed
- Three format parsers created (puz, ipuz, jpz)
- Unified importPuzzle function with format detection
- All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-puzzle-import/03-01-SUMMARY.md`
</output>
