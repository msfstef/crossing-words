---
phase: 06-collaboration
plan: 02
type: execute
---

<objective>
Implement session sharing via link and QR code, using timeline IDs for shareable URLs.

Purpose: Enable frictionless session joining - copy link or scan QR to join instantly.
Output: Timeline ID generation, shareable URL construction, ShareDialog component with link copy and QR display.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-collaboration/06-CONTEXT.md
@.planning/phases/06-collaboration/06-RESEARCH.md
@.planning/phases/06-collaboration/06-01-PLAN.md

@src/App.tsx
@src/hooks/useCrdtPuzzle.ts

**Tech stack available:** nanoid (installed in 06-01), qrcode.react (installed in 06-01)
**Established patterns:** URL hash for room ID (#room=X), Web Share API with clipboard fallback

**Constraining decisions:**
- Phase 05: URL hash pattern already established (#room=X)
- Context vision: "Copy a link to share via any channel, or show a QR when sitting with someone"

**From research:**
- Timeline ID generation: Use nanoid (21 chars, URL-safe)
- QR code: Use QRCodeSVG from qrcode.react with error correction level M
- Sharing: Web Share API with clipboard.writeText fallback
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create session URL utilities</name>
  <files>src/collaboration/sessionUrl.ts</files>
  <action>
Create src/collaboration/sessionUrl.ts with:

1. generateTimelineId(): string
   - Use nanoid() to generate 21-char URL-safe ID

2. buildShareUrl(puzzleId: string, timelineId: string): string
   - Construct URL: `${window.location.origin}${window.location.pathname}#puzzle=${encodeURIComponent(puzzleId)}&timeline=${timelineId}`
   - This replaces the simpler #room=X pattern with structured puzzle+timeline

3. parseShareUrl(): { puzzleId: string, timelineId: string } | null
   - Parse window.location.hash for puzzle= and timeline= params
   - Return null if not a share URL (fallback for legacy #room=X handled elsewhere)

4. shareSession(url: string, title: string): Promise<'shared' | 'copied' | 'cancelled'>
   - If navigator.canShare?.(shareData) is true, use navigator.share()
   - Catch AbortError and return 'cancelled'
   - Fallback: navigator.clipboard.writeText(url) and return 'copied'

Export all functions.
  </action>
  <verify>npm run build passes, all functions exported and TypeScript compiles</verify>
  <done>sessionUrl.ts exports generateTimelineId, buildShareUrl, parseShareUrl, shareSession</done>
</task>

<task type="auto">
  <name>Task 2: Create ShareDialog component</name>
  <files>src/components/ShareDialog.tsx, src/components/ShareDialog.css</files>
  <action>
Create ShareDialog component that:
- Props: isOpen: boolean, onClose: () => void, shareUrl: string, puzzleTitle: string
- Uses dialog element with modal backdrop (or div with fixed positioning)
- Shows:
  - Heading: "Share this puzzle"
  - QRCodeSVG from qrcode.react (size=200, level="M", bgColor="#1a1a2e", fgColor="#ffffff")
  - URL text in a copyable field (readonly input or code block)
  - Two buttons: "Copy Link" and "Share" (Share only if navigator.canShare is available)
  - Close button (X in corner)
- On Copy Link click: Call shareSession with fallback, show brief "Copied!" feedback
- On Share click: Call shareSession to trigger native share sheet
- Click outside or Escape closes dialog

CSS (ShareDialog.css):
- Modal overlay with semi-transparent background
- Centered dialog matching app dark theme (#1a1a2e background, #e0e0e0 text)
- QR code centered above URL
- Buttons in row at bottom
- Mobile-responsive (full width on small screens)

DON'T hand-roll QR code rendering - use QRCodeSVG component.
  </action>
  <verify>npm run build passes, component renders without errors, QR code displays</verify>
  <done>ShareDialog component renders QR code, copy link works, native share works on supported browsers</done>
</task>

<task type="auto">
  <name>Task 3: Wire ShareDialog to App with session creation flow</name>
  <files>src/App.tsx, src/App.css</files>
  <action>
Update App.tsx:

1. Add state for sharing:
   - timelineId: string | null (generated when creating/sharing session)
   - showShareDialog: boolean

2. Update URL parsing:
   - Replace getRoomIdFromHash with parseShareUrl from sessionUrl.ts
   - Extract both puzzleId and timelineId from URL
   - For backwards compatibility: if old #room=X format, treat X as timelineId (puzzleId from loaded puzzle)

3. Add "Share" button in header (near puzzle import controls):
   - Only visible when puzzle is loaded
   - On click:
     - If no timelineId exists, generate one with generateTimelineId()
     - Build share URL with buildShareUrl(puzzleId, timelineId)
     - Update URL hash to include timeline (so current user is also in the room)
     - Open ShareDialog

4. Update roomId derivation:
   - roomId for P2P = `${puzzleId}:${timelineId}` (combines both for unique room)
   - Only create P2P session when timelineId is present

5. Add ShareDialog render at end of JSX, passing shareUrl and isOpen state

CSS additions:
- Style Share button to match existing UI
- Position appropriately in header

Key insight from context: "The person joining gets a copy of that timeline's state" - this happens automatically via Yjs sync when they join the room with same roomId.
  </action>
  <verify>npm run build passes, Share button appears, clicking generates URL with timeline, QR displays, copied URL can be opened in new tab to join same session</verify>
  <done>Share button creates timeline, ShareDialog shows URL and QR, joining via URL connects to same P2P session</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] Share button visible when puzzle loaded
- [ ] Clicking Share generates URL with puzzle and timeline params
- [ ] QR code renders correctly in dialog
- [ ] Copy Link copies URL to clipboard
- [ ] Opening copied URL in new browser joins same session (entries sync)
- [ ] Mobile: Share button triggers native share sheet (test in mobile dev tools)
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- Session sharing works end-to-end
- QR code scannable and links work
</success_criteria>

<output>
After completion, create `.planning/phases/06-collaboration/06-02-SUMMARY.md` with:
- Accomplishments: Timeline ID generation, ShareDialog with QR, link sharing works
- Files Created/Modified
- Decisions Made (URL structure, share flow)
- Issues Encountered (if any)
- Next Step: "Ready for 06-03-PLAN.md (Presence UI)"
</output>
