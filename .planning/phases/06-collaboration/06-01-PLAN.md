---
phase: 06-collaboration
plan: 01
type: execute
---

<objective>
Wire up Yjs Awareness protocol for real-time presence tracking and create color assignment system for collaborators.

Purpose: Foundation for all presence features - cursors, avatars, and highlighting depend on awareness state.
Output: Awareness integration in P2P session, collaborator state types, color assignment logic, useCollaborators hook.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-collaboration/06-CONTEXT.md
@.planning/phases/06-collaboration/06-RESEARCH.md
@.planning/phases/05-p2p-networking/05-01-SUMMARY.md
@.planning/phases/05-p2p-networking/05-02-SUMMARY.md

@src/crdt/webrtcProvider.ts
@src/hooks/useCrdtPuzzle.ts
@src/hooks/usePuzzleState.ts

**Tech stack available:** y-webrtc (includes y-protocols/awareness), Yjs
**Established patterns:** useSyncExternalStore for external state, subscription pattern for state changes

**Constraining decisions:**
- Phase 05: P2PSession already has provider.awareness available
- Phase 04-02: useSyncExternalStore pattern for Yjs integration

**From research - don't hand-roll:**
- Presence tracking: Use Yjs Awareness, not custom solution
- Color assignment: Use distinct-colors library
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create awareness types</name>
  <files>package.json, src/collaboration/types.ts, src/collaboration/colors.ts</files>
  <action>
Install dependencies: `npm install nanoid qrcode.react sonner distinct-colors`

Create src/collaboration/types.ts with:
- CollaboratorState interface: { user: { name: string, color: string }, cursor: { row: number, col: number, direction: 'across' | 'down' } | null }
- LocalUserInfo type for setting local awareness state

Create src/collaboration/colors.ts with:
- Pre-generate palette of 12 distinct colors using distinct-colors library (chromaMin: 50, lightMin: 35, lightMax: 75)
- assignColor(clientId: number): string function that maps clientId % palette.length to hex color
- generateNickname(): string function with hardcoded adjective+animal lists (e.g., "Clever Fox", "Swift Owl") - keep simple, ~20 adjectives + ~20 animals

Note: nanoid, qrcode.react, and sonner are for later plans but install now to reduce plan boundaries.
  </action>
  <verify>npm run build passes, src/collaboration/types.ts and colors.ts exist with exports</verify>
  <done>Dependencies installed, CollaboratorState type exported, assignColor and generateNickname functions working</done>
</task>

<task type="auto">
  <name>Task 2: Expose awareness from P2PSession and wire to useCrdtPuzzle</name>
  <files>src/crdt/webrtcProvider.ts, src/hooks/useCrdtPuzzle.ts</files>
  <action>
Update P2PSession interface in webrtcProvider.ts:
- Add `awareness` property exposing provider.awareness (type: Awareness from y-protocols/awareness)
- In createP2PSession, after creating provider, set initial local awareness state:
  - awareness.setLocalStateField('user', { name: generateNickname(), color: assignColor(awareness.clientID) })
  - awareness.setLocalStateField('cursor', null) // Will be updated by puzzle state

Update useCrdtPuzzle to:
- Add `awareness` to return type (null when not in P2P mode)
- Return session?.provider.awareness or null

DON'T change existing connection state logic - just add awareness exposure.
  </action>
  <verify>TypeScript compiles, awareness is accessible from useCrdtPuzzle when roomId is provided</verify>
  <done>P2PSession.awareness available, useCrdtPuzzle returns awareness, local user state auto-set on session creation</done>
</task>

<task type="auto">
  <name>Task 3: Create useCollaborators hook with cursor position sync</name>
  <files>src/collaboration/useCollaborators.ts, src/hooks/usePuzzleState.ts</files>
  <action>
Create src/collaboration/useCollaborators.ts:
- Hook takes awareness (Awareness | null) as parameter
- Uses useSyncExternalStore pattern (like useCrdtPuzzle)
- Subscribe to awareness 'change' event (not 'update' - 'change' is less frequent)
- getSnapshot filters out local client, returns array of { clientId, user, cursor } objects
- Return type: Collaborator[] where Collaborator = { clientId: number, user: { name: string, color: string }, cursor: { row: number, col: number, direction: 'across' | 'down' } | null }
- Return empty array when awareness is null

Update usePuzzleState.ts:
- Add parameter for awareness to sync cursor position
- When selectedCell or direction changes, update awareness.setLocalStateField('cursor', { row, col, direction }) if awareness is available
- When selectedCell is null, set cursor to null in awareness
- Export awareness from useCrdtPuzzle return and pass through usePuzzleState return

Pattern from research:
```typescript
const subscribe = useCallback((callback: () => void) => {
  awareness.on('change', callback);
  return () => awareness.off('change', callback);
}, [awareness]);
```
  </action>
  <verify>npm run build passes, useCollaborators returns collaborator array, cursor position syncs to awareness on selection change</verify>
  <done>useCollaborators hook working, cursor positions sync to awareness when cell selected, collaborator array updates on awareness changes</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm run lint` passes (or only pre-existing warnings)
- [ ] In dev with two browser windows in same room: awareness.getStates() shows both clients
- [ ] Selecting a cell in one window updates cursor in awareness visible from other window
- [ ] Each client has unique color and nickname
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- Awareness state syncs between peers
- useCollaborators returns correct collaborator list
</success_criteria>

<output>
After completion, create `.planning/phases/06-collaboration/06-01-SUMMARY.md` with:
- Accomplishments: Dependencies installed, awareness wired up, cursor sync working
- Files Created/Modified
- Decisions Made (if any)
- Issues Encountered (if any)
- Next Step: "Ready for 06-02-PLAN.md (Session Sharing)"
</output>
