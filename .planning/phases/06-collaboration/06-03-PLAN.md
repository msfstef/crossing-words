---
phase: 06-collaboration
plan: 03
type: execute
---

<objective>
Implement visual presence indicators: collaborator avatars in header, word highlighting on grid, and join/leave toast notifications.

Purpose: Make collaboration feel alive - see who's connected and where they're working in real-time.
Output: CollaboratorAvatars component, collaborator word highlighting in CrosswordGrid, toast notifications with sonner.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-collaboration/06-CONTEXT.md
@.planning/phases/06-collaboration/06-RESEARCH.md
@.planning/phases/06-collaboration/06-01-PLAN.md
@.planning/phases/06-collaboration/06-02-PLAN.md

@src/components/CrosswordGrid.tsx
@src/components/CrosswordGrid.css
@src/App.tsx

**Tech stack available:** sonner (installed in 06-01), useCollaborators hook (from 06-01)
**Established patterns:** CSS Grid for crossword, dark theme (#1a1a2e)

**From context vision:**
- "The entire word/clue they're focused on highlights in their assigned color, not just a single cell"
- "Avatar row â€” small colored circles/initials in header showing connected collaborators"
- "Join/leave toasts â€” Brief notification when someone joins or leaves"
- "Ghost presence on disconnect â€” Show as dimmed avatar during disconnect grace period"

**From research:**
- Toast: sonner with Toaster component, toast() function
- Awareness changes have added/removed arrays in change event
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add toast notifications for join/leave events</name>
  <files>src/collaboration/useCollaborators.ts, src/App.tsx, src/index.css</files>
  <action>
Update useCollaborators.ts to track join/leave:
- Import toast from 'sonner'
- In the awareness change handler, after filtering states:
  - If added array has entries, look up user name from awareness.getStates().get(clientId)?.user?.name
  - Call toast(`${name} joined`, { icon: 'ðŸ‘‹', duration: 3000 })
  - If removed array has entries, call toast('Someone left', { duration: 2000 })
- Only show toasts after initial load (skip first render to avoid showing existing users)

Update App.tsx:
- Import Toaster from 'sonner'
- Add <Toaster position="bottom-center" theme="dark" /> at end of JSX

Update src/index.css:
- Add any needed sonner theme overrides to match app style (may not be needed with theme="dark")

Pattern from research:
```typescript
awareness.on('change', ({ added, updated, removed }) => {
  if (added.length > 0) {
    const newUser = awareness.getStates().get(added[0])?.user;
    if (newUser) toast(`${newUser.name} joined`, { icon: 'ðŸ‘‹' });
  }
});
```

Note: Keep join/leave detection in the hook, not in a separate component, to avoid duplicate listeners.
  </action>
  <verify>npm run build passes, joining a session shows "X joined" toast, leaving shows "Someone left"</verify>
  <done>Toast notifications appear on collaborator join/leave with correct names</done>
</task>

<task type="auto">
  <name>Task 2: Create CollaboratorAvatars component</name>
  <files>src/components/CollaboratorAvatars.tsx, src/components/CollaboratorAvatars.css, src/App.tsx</files>
  <action>
Create CollaboratorAvatars.tsx:
- Props: collaborators: Collaborator[] (from useCollaborators)
- Render a row of small circular avatars:
  - Each avatar: 24px circle with user's color as background
  - Display first letter of name (or first 2 letters) in white
  - Tooltip on hover showing full name
- If collaborators array is empty, render nothing (don't show empty container)
- Limit display to first 8 collaborators, show "+N" indicator if more

Create CollaboratorAvatars.css:
- Flex row with small gap (4px)
- Avatar circles with border-radius: 50%
- Font size small for initials (12px)
- Dark background border to separate from header
- "+N more" badge styling

Update App.tsx:
- Import CollaboratorAvatars
- Call useCollaborators(awareness) to get collaborator list (awareness comes from usePuzzleState or useCrdtPuzzle)
- Render CollaboratorAvatars in header, near the connection indicator
- Only render when in P2P mode (timelineId exists) and collaborators.length > 0

Layout consideration: Position avatars in header row, perhaps between title and Share button.
  </action>
  <verify>npm run build passes, avatars appear when collaborators connect, correct colors and initials shown</verify>
  <done>CollaboratorAvatars component shows connected users with colored circles and initials</done>
</task>

<task type="auto">
  <name>Task 3: Add collaborator word highlighting to CrosswordGrid</name>
  <files>src/components/CrosswordGrid.tsx, src/components/CrosswordGrid.css, src/hooks/usePuzzleState.ts</files>
  <action>
Update CrosswordGrid component:
- Add prop: collaborators: Collaborator[]
- For each collaborator with a non-null cursor:
  - Calculate the cells in their current word (same logic as currentWord for local user)
  - Apply a semi-transparent highlight in their color to those cells
  - Use CSS background-color with alpha (e.g., rgba from hex + 0.3 opacity)

Implementation approach:
- Create helper: getWordCells(puzzle, row, col, direction) - extract from existing getCurrentWordAndClue logic
- For each cell, check if any collaborator's word includes it
- If multiple collaborators on same word, show first one's color (or blend - keep simple)

Update CrosswordGrid.css:
- Add .cell--collaborator-highlight class with data attribute for color
- Use inline style for dynamic color: style={{ backgroundColor: `${color}40` }} (hex + 40 = 25% opacity)
- Ensure collaborator highlight doesn't override local selection highlight (z-index or specificity)

Update usePuzzleState.ts:
- Export the getWordCells helper so CrosswordGrid can use it
- Or pass collaborators through and let CrosswordGrid compute word cells

Visual hierarchy (front to back):
1. Local user selection (brightest, current word)
2. Local user current word highlight
3. Collaborator word highlights (semi-transparent, their color)
4. Normal cell background

DON'T make highlight too intense - should be subtle indication, not distracting.
  </action>
  <verify>npm run build passes, collaborator cursor positions show highlighted words in their color, multiple collaborators show distinct colors</verify>
  <done>Collaborator word highlighting visible on grid, colors match avatars, doesn't interfere with local selection</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Full presence UI: avatars in header, word highlighting on grid, join/leave toasts</what-built>
  <how-to-verify>
    1. Run: npm run dev (and signaling server if in dev mode)
    2. Open http://localhost:5173 in two browser windows
    3. Load a puzzle, click Share in first window, copy link
    4. Open copied link in second window
    5. Verify: Toast shows "X joined" in first window
    6. Select different cells in each window
    7. Verify: Avatar appears in header of each window showing the other user
    8. Verify: Each user's selected word highlights in their assigned color in the other window
    9. Close second window
    10. Verify: Toast shows "Someone left" in first window, avatar disappears
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] Toast notifications appear on join/leave
- [ ] CollaboratorAvatars shows correct avatars with colors
- [ ] Word highlighting shows collaborator positions
- [ ] Colors are consistent between avatar and highlight
- [ ] Human verification checkpoint approved
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Human verification approved
- Presence feels "alive" - can see collaborators in real-time
</success_criteria>

<output>
After completion, create `.planning/phases/06-collaboration/06-03-SUMMARY.md` with:
- Accomplishments: Toasts working, avatars displayed, word highlighting implemented
- Files Created/Modified
- Decisions Made (visual design choices)
- Issues Encountered (if any)
- Next Step: "Ready for 06-04-PLAN.md (Timeline Join Flow)"
</output>
