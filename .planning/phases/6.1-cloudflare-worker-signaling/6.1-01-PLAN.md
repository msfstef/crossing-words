---
phase: 6.1-cloudflare-worker-signaling
plan: 01
type: execute
---

<objective>
Deploy production signaling server using Cloudflare Durable Objects with WebSocket Hibernation API.

Purpose: Replace unreliable public signaling servers with a custom Cloudflare Worker that implements the y-webrtc signaling protocol, enabling production-ready P2P connections.
Output: Working signaling endpoint at `wss://crossing-words-proxy.<subdomain>.workers.dev/signaling` with client integration.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/6.1-cloudflare-worker-signaling/6.1-RESEARCH.md
@.planning/phases/05-p2p-networking/05-01-SUMMARY.md
@.planning/phases/05-p2p-networking/05-02-SUMMARY.md
@proxy/src/index.ts
@proxy/wrangler.toml
@src/crdt/webrtcProvider.ts

**Key decisions from prior phases:**
- Local signaling server (ws://localhost:4444) in dev mode - public servers unreliable
- y-webrtc signaling protocol: 4 message types (subscribe, unsubscribe, publish, ping/pong)
- Room isolation via topics in y-webrtc protocol, not route-per-room

**Research findings (6.1-RESEARCH.md):**
- Use Durable Objects with WebSocket Hibernation API (cost-efficient, ~$0 for typical usage)
- Extend existing proxy worker with /signaling route + SignalingRoom DO class
- Single /signaling/global route; y-webrtc handles room isolation via topics
- serializeAttachment for topic state recovery after hibernation (if needed)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SignalingRoom Durable Object</name>
  <files>proxy/src/SignalingRoom.ts</files>
  <action>
Create the SignalingRoom Durable Object class implementing y-webrtc signaling protocol:

1. Import `DurableObject` from `cloudflare:workers`
2. Implement `fetch()` method for WebSocket upgrade using Hibernation API:
   - Check for `Upgrade: websocket` header, return 426 if missing
   - Create WebSocketPair, accept server socket with `this.ctx.acceptWebSocket(server)`
   - Return 101 response with client socket
3. Implement `webSocketMessage()` handler for y-webrtc protocol:
   - `ping` → respond with `pong`
   - `publish` with `topic` → broadcast to all connected WebSockets (y-webrtc handles topic filtering client-side)
   - Include `clients` count in publish response (y-webrtc protocol requirement)
4. Implement `webSocketClose()` for cleanup (empty - CF handles)

**Critical:** Use `this.ctx.acceptWebSocket(server)` (Hibernation API), NOT `ws.accept()` (standard API). This is required for cost efficiency - only billed during message processing, not connection duration.

**Skip for now:** Topic subscription state via serializeAttachment - y-webrtc re-subscribes on reconnect, test if needed later.
  </action>
  <verify>TypeScript compiles without errors: `cd proxy && npx tsc --noEmit`</verify>
  <done>SignalingRoom.ts exists with Hibernation API WebSocket handling and y-webrtc message protocol</done>
</task>

<task type="auto">
  <name>Task 2: Add signaling route and deploy</name>
  <files>proxy/src/index.ts, proxy/wrangler.toml</files>
  <action>
1. Update wrangler.toml:
   - Add Durable Object binding:
     ```toml
     [[durable_objects.bindings]]
     name = "SIGNALING_ROOM"
     class_name = "SignalingRoom"

     [[migrations]]
     tag = "v1"
     new_classes = ["SignalingRoom"]
     ```

2. Update index.ts:
   - Add SIGNALING_ROOM to Env interface: `SIGNALING_ROOM: DurableObjectNamespace;`
   - Add route BEFORE the 404 handler:
     ```typescript
     // WebSocket signaling for P2P
     if (url.pathname === '/signaling') {
       const id = env.SIGNALING_ROOM.idFromName('global');
       const stub = env.SIGNALING_ROOM.get(id);
       return stub.fetch(request);
     }
     ```
   - Export SignalingRoom class at bottom: `export { SignalingRoom } from './SignalingRoom';`

3. Deploy to Cloudflare:
   ```bash
   cd proxy && npx wrangler deploy
   ```

**Note:** Using single `/signaling` route with `idFromName('global')` because y-webrtc handles room isolation via topics in its pub/sub protocol. One DO instance handles all rooms.
  </action>
  <verify>
1. Deploy succeeds without errors
2. Test health check: `curl https://crossing-words-proxy.msfstef.workers.dev/` returns 200
3. Test WebSocket locally (dev): `cd proxy && npx wrangler dev` then `npx wscat -c ws://localhost:8787/signaling` and send `{"type":"ping"}` - should receive `{"type":"pong"}`
  </verify>
  <done>Worker deployed with /signaling WebSocket endpoint responding to ping/pong</done>
</task>

<task type="auto">
  <name>Task 3: Update client to use production signaling</name>
  <files>src/crdt/webrtcProvider.ts</files>
  <action>
Update `getSignalingServers()` function to use the deployed Cloudflare Worker in production:

```typescript
function getSignalingServers(): string[] {
  if (import.meta.env.DEV) {
    return ['ws://localhost:4444'];
  }

  // Production: Cloudflare Worker signaling
  return ['wss://crossing-words-proxy.msfstef.workers.dev/signaling'];
}
```

Remove the old unreliable public server URLs (signaling.yjs.dev, herokuapp).

**Keep localhost:4444 for development** - the y-webrtc bin/server.js remains useful for local testing without needing the deployed worker.
  </action>
  <verify>
1. Build succeeds: `npm run build`
2. Start production preview: `npm run preview`
3. Open in browser, load a puzzle, share with another tab via URL - both tabs should connect (check for "Connected" indicator)
  </verify>
  <done>Production build uses Cloudflare Worker signaling, P2P connections work in production mode</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `cd proxy && npx wrangler deploy` succeeds
- [ ] WebSocket ping/pong works via wrangler dev
- [ ] `npm run build` succeeds without errors
- [ ] P2P sync works in production preview (two browser tabs with same URL hash can sync)
</verification>

<success_criteria>

- SignalingRoom Durable Object deployed with Hibernation API
- /signaling WebSocket endpoint responds to y-webrtc protocol
- Client uses production signaling server (not unreliable public servers)
- P2P puzzle sync works end-to-end in production mode
</success_criteria>

<output>
After completion, create `.planning/phases/6.1-cloudflare-worker-signaling/6.1-01-SUMMARY.md`:

# Phase 6.1 Plan 1: Cloudflare Worker Signaling Summary

**[Substantive one-liner]**

## Accomplishments

- [Key outcomes]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

[Ready for Phase 7: Check/Reveal]
</output>
