---
phase: 05-p2p-networking
plan: 02
type: execute
---

<objective>
Add connection state tracking and offline-first resilience to P2P sync.

Purpose: Ensure the app gracefully handles network changes - users can continue solving offline and sync resumes automatically on reconnect.
Output: Connection state indicator, robust offline behavior, and Playwright tests validating resilience.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-p2p-networking/05-RESEARCH.md
@.planning/phases/05-p2p-networking/05-CONTEXT.md
@.planning/phases/05-p2p-networking/05-01-SUMMARY.md

@src/crdt/webrtcProvider.ts
@src/hooks/useCrdtPuzzle.ts
@src/App.tsx

**From 05-01:**
- y-webrtc installed and configured
- createP2PSession creates WebrtcProvider
- useCrdtPuzzle accepts roomId for P2P mode
- Playwright test infrastructure set up

**From RESEARCH.md - Pitfalls to avoid:**
- Pitfall 4: Provider not destroyed on cleanup → already handled in 05-01
- Pitfall 6: One-directional sync after reconnection → monitor and handle with destroy/recreate pattern

**From CONTEXT.md - Essential:**
- Offline-first: Keep solving locally, sync catches up when reconnected
- Connection reliability: It just works across NATs, firewalls, mobile networks
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add connection state tracking to P2P session</name>
  <files>src/crdt/webrtcProvider.ts, src/hooks/useCrdtPuzzle.ts</files>
  <action>
1. In webrtcProvider.ts:
   - Define ConnectionState type: 'disconnected' | 'connecting' | 'connected'
   - Update P2PSession interface to include:
     - connectionState: ConnectionState
     - onConnectionChange: (callback: (state: ConnectionState) => void) => () => void
   - In createP2PSession:
     - Track connection state internally
     - Listen to provider.on('status', ...) events
     - Provide onConnectionChange subscription method
     - Initial state is 'connecting'

2. In useCrdtPuzzle.ts:
   - Add connectionState to UseCrdtPuzzleReturn interface
   - Add connectionStateRef = useRef<ConnectionState>('disconnected')
   - Subscribe to session.onConnectionChange in useEffect
   - Update ref and notify subscribers when state changes
   - Return connectionState from hook
   - When no roomId provided, connectionState should be 'disconnected' (solo mode)

3. Connection state logic:
   - No roomId → 'disconnected' (solo mode, not an error)
   - roomId provided, session creating → 'connecting'
   - provider.on('status', { connected: true }) → 'connected'
   - provider.on('status', { connected: false }) → 'disconnected'
  </action>
  <verify>npm run build succeeds, useCrdtPuzzle returns connectionState</verify>
  <done>connectionState tracks P2P connection lifecycle, exposed from useCrdtPuzzle hook</done>
</task>

<task type="auto">
  <name>Task 2: Add connection state UI indicator and handle reconnection</name>
  <files>src/App.tsx, src/App.css</files>
  <action>
1. In App.tsx:
   - Destructure connectionState from useCrdtPuzzle
   - Add connection indicator component (only show when roomId is set):
     - 'connecting' → yellow dot + "Connecting..."
     - 'connected' → green dot + "Connected" (or just green dot, minimal)
     - 'disconnected' → red dot + "Offline" (when was connected but lost)
   - Position indicator in top-right corner, subtle but visible

2. In App.css:
   - Style connection indicator with colored dots
   - Use CSS for dot colors: --connected (green), --connecting (yellow), --disconnected (red)
   - Keep it minimal - small indicator, doesn't distract from puzzle

3. Reconnection handling approach:
   - For Phase 5, rely on y-webrtc's built-in reconnection
   - y-webrtc automatically attempts to reconnect on disconnect
   - If RESEARCH.md pitfall 6 (one-directional sync) occurs, we'll address in future phase
   - Log connection state changes for debugging: console.debug('[P2P] state:', state)

4. Solo mode (no roomId):
   - Don't show connection indicator at all
   - User is just solving locally, no P2P expected
  </action>
  <verify>npm run build succeeds, connection indicator visible when using roomId</verify>
  <done>Connection indicator shows current P2P state, reconnection handled by y-webrtc</done>
</task>

<task type="auto">
  <name>Task 3: Verify offline-first behavior with Playwright</name>
  <files>e2e/p2p-offline.spec.ts</files>
  <action>
1. Create e2e/p2p-offline.spec.ts with tests:

Test 1: "continues working offline and syncs on reconnect"
  a. Create two browser contexts, connect to same roomId
  b. Wait for both to show 'connected' state
  c. page1 types 'A' in cell, verify page2 sees it (baseline sync works)
  d. Take page2 offline: await context2.setOffline(true)
  e. page1 types 'B' in different cell
  f. page2 types 'C' in another cell (should work locally)
  g. Verify page2 still shows its own 'C' (local state works offline)
  h. Bring page2 back online: await context2.setOffline(false)
  i. Wait for sync (up to 2 seconds)
  j. Verify page2 now shows 'B' (received from page1)
  k. Verify page1 now shows 'C' (received from page2)

Test 2: "IndexedDB persists entries while offline"
  a. Single context, with roomId
  b. Type some letters
  c. Take offline
  d. Type more letters
  e. Reload page (while offline)
  f. Verify all letters still present (IndexedDB persistence works)

2. Use Playwright's context.setOffline(true/false) for network simulation

3. Add reasonable timeouts - P2P reconnection can take 1-2 seconds

4. Run: `npx playwright test e2e/p2p-offline.spec.ts`
  </action>
  <verify>npx playwright test e2e/p2p-offline.spec.ts passes</verify>
  <done>Playwright tests confirm offline-first behavior and sync-on-reconnect works</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm run lint` passes (or only pre-existing warnings)
- [ ] `npx playwright test` passes all P2P tests (sync and offline)
- [ ] Manual test: open with #room=X, see connection indicator
- [ ] Manual test: disconnect network, continue typing, reconnect, verify sync
</verification>

<success_criteria>

- connectionState exposed from useCrdtPuzzle ('disconnected' | 'connecting' | 'connected')
- Connection indicator visible when in P2P mode (roomId set)
- Offline typing continues to work (IndexedDB persistence)
- Sync resumes when reconnected
- Playwright tests validate offline-first behavior
- Phase 5 complete: P2P networking foundation ready for Phase 6 (Collaboration)
</success_criteria>

<output>
After completion, create `.planning/phases/05-p2p-networking/05-02-SUMMARY.md`

Final summary should note:
- Phase 5 complete
- Ready for Phase 6: Collaboration (presence, cursors, session sharing UI)
</output>
